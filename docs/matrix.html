<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Matrix: Airlines × Typen</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:16px;max-width:1400px}
    .top{display:flex;gap:12px;align-items:baseline;flex-wrap:wrap}
    h1{font-size:20px;margin:0}
    .muted{color:#666;font-size:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    a{color:#000}
    .btn{display:inline-block;border:1px solid #ddd;border-radius:10px;padding:8px 10px;text-decoration:none}
    .btn:hover{background:#fafafa}
    .card{border:1px solid #ddd;border-radius:12px;padding:12px;margin:10px 0;background:#fff}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select{padding:8px;border:1px solid #ddd;border-radius:10px;font-size:14px}
    label{display:flex;gap:6px;align-items:center}

    /* Desktop/Tablet Matrix */
    #matrixCard{padding:0}
    #topScroll{overflow:auto;border-bottom:1px solid #eee}
    #topScrollInner{height:1px}
    #tableWrap{overflow:auto;max-height:75vh}
    table{width:max-content;border-collapse:collapse;font-size:12px}
    th,td{
      border:1px solid #e6e6e6;
      padding:6px 8px;
      vertical-align:top;
      background:#fff;
    }
    th{position:sticky;top:0;z-index:3}
    td:first-child, th:first-child{position:sticky;left:0;z-index:2}
    tr:nth-child(even) td{background:#fafafa}
    td.num{text-align:right;font-variant-numeric:tabular-nums}
    td.num a{display:block;text-decoration:none;color:#000}
    td.num a:hover{text-decoration:underline}

    /* Mobile view */
    #mobileCard{display:none}
    #mobileTbl td, #mobileTbl th{border-bottom:1px solid #eee;padding:6px 8px;font-size:14px}
    #mobileTbl td.num{text-align:right;font-variant-numeric:tabular-nums}
    #mobileTbl td.num a{color:#000;text-decoration:none;display:inline-block;padding:2px 6px;border:1px solid #ddd;border-radius:10px}
    #mobileTbl td.num a:hover{background:#fafafa}
    .pill{display:inline-block;border:1px solid #ddd;border-radius:999px;padding:2px 8px;font-size:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}

    @media (max-width: 900px){
      body{margin:12px}
      #tableWrap{max-height:70vh}
    }

    /* Switch to mobile layout */
    @media (max-width: 720px){
      #matrixCard{display:none}
      #mobileCard{display:block}
    }
  </style>
</head>
<body>
  <div class="top">
    <h1>Matrix: Airlines × Typen</h1>
    <span class="muted" id="meta"></span>
  </div>

  <div class="row">
    <a class="btn" href="./index.html">← Übersicht</a>
    <a class="btn" href="./missing_types.html">Fehlende Typen</a>
  </div>

  <!-- Desktop/Tablet controls -->
  <div class="card controls" id="desktopControls">
    <label class="muted">Airline enthält:
      <input id="airQ" placeholder="z.B. Austrian" />
    </label>
    <label class="muted">Typ enthält:
      <input id="typeQ" placeholder="z.B. A320" />
    </label>
    <span class="muted">Tipp: Horizontal oben scrollen.</span>
  </div>

  <!-- Desktop/Tablet matrix -->
  <div class="card" id="matrixCard">
    <div id="topScroll"><div id="topScrollInner"></div></div>
    <div id="tableWrap">
      <table id="tbl"></table>
    </div>
  </div>

  <!-- Mobile controls + list -->
  <div class="card" id="mobileCard">
    <div class="controls" style="margin-bottom:10px">
      <label class="muted">Airline:
        <select id="mAir"></select>
      </label>
      <label class="muted">Typ-Suche:
        <input id="mTypeQ" placeholder="z.B. A320" />
      </label>
      <label class="muted">Nur vorhanden:
        <select id="mOnlyNonZero">
          <option value="true">ja</option>
          <option value="false">nein</option>
        </select>
      </label>
    </div>
    <div class="muted" id="mMeta"></div>
    <table id="mobileTbl" style="width:100%;border-collapse:collapse;margin-top:10px">
      <thead>
        <tr>
          <th style="text-align:right;border-bottom:1px solid #eee;padding:6px 8px">#</th>
          <th style="text-align:left;border-bottom:1px solid #eee;padding:6px 8px">Typ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
  function esc(s){
    return String(s??"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  let data = null;

  function renderDesktop(){
    if(!data) return;

    const airQ = (document.getElementById("airQ").value || "").trim().toLowerCase();
    const typeQ = (document.getElementById("typeQ").value || "").trim().toLowerCase();

    const airlines = data.airlines || [];
    const types = data.types || [];
    const matrix = data.matrix || [];

    const ai = airlines
      .map((a, idx) => ({a, idx}))
      .filter(x => !airQ || x.a.toLowerCase().includes(airQ));

    const ti = types
      .map((t, idx) => ({t, idx}))
      .filter(x => !typeQ || x.t.toLowerCase().includes(typeQ));

    let html = "<thead><tr><th>Typ \\ Airline</th>";
    for(const x of ai){
      html += `<th>${esc(x.a)}</th>`;
    }
    html += "</tr></thead><tbody>";

    for(const y of ti){
      html += `<tr><td>${esc(y.t)}</td>`;
      for(const x of ai){
        const n = (matrix[x.idx] && matrix[x.idx][y.idx]) ? matrix[x.idx][y.idx] : 0;

        // optional: click to jump to index.html filtered (airline + type)
        if(n){
          const href = `./index.html?airline=${encodeURIComponent(x.a)}&type=${encodeURIComponent(y.t)}`;
          html += `<td class="num"><a href="${esc(href)}" title="Öffnen in Übersicht">${n}</a></td>`;
        }else{
          html += `<td class="num"></td>`;
        }
      }
      html += "</tr>";
    }
    html += "</tbody>";

    document.getElementById("tbl").innerHTML = html;
    document.getElementById("meta").textContent =
      `${ai.length} Airlines · ${ti.length} Typen (aus ${airlines.length}×${types.length})`;

    // Sync top scrollbar width + scroll position
    requestAnimationFrame(() => {
      const wrap = document.getElementById("tableWrap");
      const top = document.getElementById("topScroll");
      const inner = document.getElementById("topScrollInner");
      const tbl = document.getElementById("tbl");
      if(!wrap || !top || !inner || !tbl) return;

      inner.style.width = tbl.scrollWidth + "px";

      top.onscroll = () => { wrap.scrollLeft = top.scrollLeft; };
      wrap.onscroll = () => { top.scrollLeft = wrap.scrollLeft; };
    });
  }

  function initMobile(){
    if(!data) return;
    const mAir = document.getElementById("mAir");

    // build airline dropdown
    mAir.innerHTML = "";
    const optAll = document.createElement("option");
    optAll.value = "";
    optAll.textContent = "Alle Airlines";
    mAir.appendChild(optAll);

    for(const a of (data.airlines || [])){
      const opt = document.createElement("option");
      opt.value = a;
      opt.textContent = a;
      mAir.appendChild(opt);
    }

    document.getElementById("mAir").addEventListener("change", renderMobile);
    document.getElementById("mTypeQ").addEventListener("input", renderMobile);
    document.getElementById("mOnlyNonZero").addEventListener("change", renderMobile);

    renderMobile();
  }

  function renderMobile(){
    if(!data) return;

    const airlines = data.airlines || [];
    const types = data.types || [];
    const matrix = data.matrix || [];

    const selectedAir = (document.getElementById("mAir").value || "");
    const typeQ = (document.getElementById("mTypeQ").value || "").trim().toLowerCase();
    const onlyNonZero = (document.getElementById("mOnlyNonZero").value === "true");

    let airlineIdx = -1;
    if(selectedAir){
      airlineIdx = airlines.indexOf(selectedAir);
    }

    // If no airline selected: show top airlines summary
    // But simpler: require selection for meaningful list
    if(airlineIdx < 0){
      document.getElementById("mMeta").innerHTML =
        `<span class="pill">Bitte Airline wählen</span> <span class="muted">(${airlines.length} verfügbar)</span>`;
      document.querySelector("#mobileTbl tbody").innerHTML = "";
      return;
    }

    const rows = [];
    for(let ti = 0; ti < types.length; ti++){
      const t = types[ti];
      if(typeQ && !t.toLowerCase().includes(typeQ)) continue;

      const n = (matrix[airlineIdx] && matrix[airlineIdx][ti]) ? matrix[airlineIdx][ti] : 0;
      if(onlyNonZero && !n) continue;

      rows.push({t, n});
    }

    rows.sort((a,b) => a.t.localeCompare(b.t));

    document.getElementById("mMeta").innerHTML =
      `<span class="pill">${esc(selectedAir)}</span> ` +
      `<span class="pill">Treffer: <span class="mono">${rows.length}</span></span>`;

    const tbody = document.querySelector("#mobileTbl tbody");
    tbody.innerHTML = rows.map(x => {
      const href = `./index.html?airline=${encodeURIComponent(selectedAir)}&type=${encodeURIComponent(x.t)}`;
      const n = x.n ? x.n : 0;
    
      return `
        <tr>
          <td class="num">
            <a href="${esc(href)}" title="In Übersicht öffnen">${esc(n)}</a>
          </td>
          <td>${esc(x.t)}</td>
        </tr>
      `;
    }).join("");
  }

  async function main(){
    const res = await fetch("./data/matrix.json", {cache:"no-store"});
    data = await res.json();

    renderDesktop();
    initMobile();

    document.getElementById("airQ").addEventListener("input", renderDesktop);
    document.getElementById("typeQ").addEventListener("input", renderDesktop);
  }

  main();
</script>
</body>
</html>
