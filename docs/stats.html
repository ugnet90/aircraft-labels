<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stats</title>
  <link rel="stylesheet" href="./style.css">
  <link rel="stylesheet" href="./stats.css">
</head>
<body>

<nav class="nav">
  <div class="navInner">
    <div class="navRight">
      <a href="./index.html">Übersicht</a>
      <a href="./matrix.html">Matrix</a>
      <a href="./missing_types.html">Fehlende Typen</a>
      <a href="./types_overview.html">Typen</a>
      <a href="./flights.html">Flüge</a>
      <a class="active" href="./stats.html">Stats</a>
    </div>
  </div>
</nav>

<div class="top" style="margin-top:10px">
  <h1>Statistik</h1>
  <span class="muted" id="meta"></span>
</div>

<div id="content">Lade Daten …</div>

<script>

let STATE = {
  expandedAir: "",   // logo_id
  expandedCat: "",   // "", "exact_owned", "type_owned", "exact_ordered", "type_ordered"
};

let CACHE = {
  flights: [],
  models: [],
  logoName: {}, // logo_id -> "Airline"
  airlineStats: [], // render-ready array
};

function esc(s){
  return String(s??"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function asText(v){ return (v??"").toString().trim(); }

async function fetchCsvMapLogoToAirline(){
  const res = await fetch("./data/airline_logos.csv", {cache:"no-store"});
  if(!res.ok) throw new Error(`airline_logos.csv HTTP ${res.status}`);

  const text = await res.text();

  // ; getrennt, 1. Zeile Header: logo_id;Airline;...
  const lines = text.split(/\r?\n/).filter(x => x.trim() !== "");
  if(lines.length < 2) return {};

  const header = lines[0].split(";").map(x => x.trim());
  const idxLogo = header.indexOf("logo_id");
  const idxAir  = header.indexOf("Airline");     // wichtig: genau "Airline"
  const idxFull = header.indexOf("full_name");   // optional

  const map = {};
  for(let i=1;i<lines.length;i++){
    const cols = lines[i].split(";");

    const logo = (cols[idxLogo] || "").trim();
    const air  = (cols[idxAir]  || "").trim();
    const full = idxFull >= 0 ? (cols[idxFull] || "").trim() : "";

    if(!logo) continue;
    map[logo] = air || full || logo;
  }
  return map;
}

function dot(key, filled){
  const cls = key === "owned"
    ? (filled ? "dot dotG" : "dot dotGRing")
    : (filled ? "dot dotY" : "dot dotYRing");
  return `<span class="${cls}"></span>`;
}

function modelStatus(m){
  if(m.status === "owned")   return {key:"owned"};
  if(m.status === "ordered") return {key:"ordered"};
  return {key:""};
}

function analyzeFlight(models, flight){
  const fAircraftId = asText(flight.aircraft_id);
  const fReg = asText(flight.registration);
  const fLogo = asText(flight.logo_id).toLowerCase().trim();
  const fAirText = (asText(flight.airline) || "").toLowerCase().trim(); // optional, falls vorhanden

  const sameAirline = (m) => {
    // 1) stärkste Übereinstimmung: logo_id
    const mLogo = asText(m.logo_id).toLowerCase().trim();
    if(fLogo && mLogo && fLogo === mLogo) return true;

    // 2) fallback: Airline-Text (falls flights.json airline hat)
    if(fAirText){
      const mAir =
        (asText(m.airline_row) || asText(m.airline_code) || asText(m.airline)).toLowerCase().trim();
      return !!mAir && (mAir === fAirText);
    }

    return false;
  };

  const sameType = (m) => fAircraftId && asText(m.aircraft_id) === fAircraftId;
  const sameReg  = (m) => fReg && asText(m.registration) === fReg;

  const airlineTypeModels = models.filter(m => sameType(m) && sameAirline(m));
  const exactModels = airlineTypeModels.filter(m => sameReg(m));

  return { airlineTypeModels, exactModels };
}

function uniqueCount(arr){
  return new Set(arr.filter(Boolean)).size;
}

async function main(){

  const resF = await fetch("./data/flights.json",{cache:"no-store"});
  const flightsData = await resF.json();
  const flights = flightsData.items || [];

  const resI = await fetch("./index.json",{cache:"no-store"});
  const idx = await resI.json();
  const models = idx.items || [];

  //logoMap = await fetchCsvMapLogoToAirline();
  
  // logo_id -> Anzeige-Airline (aus index.json abgeleitet)
  const airlineNameByLogo = {};
  for(const m of models){
    const lid = asText(m.logo_id);
    if(lid && !airlineNameByLogo[lid]){
      airlineNameByLogo[lid] = asText(m.airline_row) || asText(m.airline) || asText(m.airline_code) || lid;
    }
  }
  
  function flightAirlineLabel(f){
    const lid = asText(f.logo_id);
    return (
      asText(f.airline_row) ||     // wenn flights.json das hat -> perfekt
      asText(f.airline) ||         // falls du es doch mal wieder einführst
      (lid && airlineNameByLogo[lid]) ||
      lid
    );
  }

  document.getElementById("meta").textContent =
    `${flights.length} Flüge`;

  // --- OVERVIEW ---

  const airlines = flights.map(f => flightAirlineLabel(f));
  const types = flights.map(f=>asText(f.aircraft_id));
  const regs = flights.map(f=>asText(f.registration));
  const routes = flights.map(f=>asText(f.from)+"-"+asText(f.to));

  // Sammlung-Abdeckung
  let exactOwned=0, exactOrdered=0, typeOwned=0, typeOrdered=0, none=0;

  flights.forEach(f=>{
    const a = analyzeFlight(models, f);

    if(a.exactModels.length){
      if(a.exactModels.some(m=>m.status==="owned")) exactOwned++;
      else if(a.exactModels.some(m=>m.status==="ordered")) exactOrdered++;
    }
    else if(a.airlineTypeModels.length){
      if(a.airlineTypeModels.some(m=>m.status==="owned")) typeOwned++;
      else if(a.airlineTypeModels.some(m=>m.status==="ordered")) typeOrdered++;
    }
    else none++;
  });

  let html = `
  <div class="card">
    <div class="k">Überblick</div>
    <div class="kpiWrap">
      <span class="kpi">Flüge: <b>${flights.length}</b></span>
      <span class="kpi">Airlines: <b>${uniqueCount(airlines)}</b></span>
      <span class="kpi">Typen: <b>${uniqueCount(types)}</b></span>
      <span class="kpi">Registrierungen: <b>${uniqueCount(regs)}</b></span>
      <span class="kpi">Routen: <b>${uniqueCount(routes)}</b></span>
    </div>

    <div class="coverage">
      <div>${dot("owned",true)} exakt vorhanden: ${exactOwned}</div>
      <div>${dot("ordered",true)} exakt bestellt: ${exactOrdered}</div>
      <div>${dot("owned",false)} Typ vorhanden: ${typeOwned}</div>
      <div>${dot("ordered",false)} Typ bestellt: ${typeOrdered}</div>
      <div>❌ kein Modell: ${none}</div>
    </div>
  </div>
  `;

  // --- AIRLINES (mit Drilldown) ---
  
  // logo_id -> Airline-Name (aus index.json, weil flights.json nicht mehr "airline" enthält)
  function buildLogoName(models){
    const m = {};
    for(const x of models){
      const lid = asText(x.logo_id);
      if(!lid) continue;
      const name = asText(x.airline_row) || asText(x.airline) || asText(x.airline_code);
      if(name && !m[lid]) m[lid] = name;
    }
    return m;
  }
  
  function uniq(arr){
    return Array.from(new Set(arr.filter(Boolean)));
  }
  
  // Coverage je Flug (entspricht deinem Punkt-Design)
  function covOfFlight(models, f){
    const a = analyzeFlight(models, f);
  
    // exact
    if(a.exactModels.length){
      const owned = a.exactModels.some(m => asText(m.status)==="owned");
      const ordered = a.exactModels.some(m => asText(m.status)==="ordered");
      if(owned)   return {cat:"exact_owned",   models: a.exactModels.filter(m=>asText(m.status)==="owned")};
      if(ordered) return {cat:"exact_ordered", models: a.exactModels.filter(m=>asText(m.status)==="ordered")};
    }
  
    // airline+type
    if(a.airlineTypeModels.length){
      const owned = a.airlineTypeModels.some(m => asText(m.status)==="owned");
      const ordered = a.airlineTypeModels.some(m => asText(m.status)==="ordered");
      if(owned)   return {cat:"type_owned",   models: a.airlineTypeModels.filter(m=>asText(m.status)==="owned")};
      if(ordered) return {cat:"type_ordered", models: a.airlineTypeModels.filter(m=>asText(m.status)==="ordered")};
    }
  
    return {cat:"none", models: []};
  }
  
  function dotHtml(cat){
    if(cat==="exact_owned")   return dot("owned", true);
    if(cat==="type_owned")    return dot("owned", false);
    if(cat==="exact_ordered") return dot("ordered", true);
    if(cat==="type_ordered")  return dot("ordered", false);
    return "";
  }
  
  function airlineLabel(logoId){
    return CACHE.logoName[logoId] || logoId;
  }
  
  function buildAirlineStats(){
    const map = new Map();
  
    for(const f of CACHE.flights){
      const lid = asText(f.logo_id);
      if(!lid) continue;
  
      const cov = covOfFlight(CACHE.models, f);
      f.__cov = cov;
  
      if(!map.has(lid)){
        map.set(lid, {
          logo_id: lid,
          flights: [],
          total: 0,
          exact_owned: 0,
          type_owned: 0,
          exact_ordered: 0,
          type_ordered: 0,
        });
      }
  
      const s = map.get(lid);
      s.flights.push(f);
      s.total++;
  
      if(cov.cat && cov.cat !== "none"){
        s[cov.cat] = (s[cov.cat] || 0) + 1;
      }
    }
  
    const arr = Array.from(map.values());
    arr.sort((a,b)=>b.total - a.total);
    return arr;
  }
  
  function flightSortDesc(a,b){
    // date desc, time desc (gleiches Verhalten wie flights.html)
    const da = asText(a.date), db = asText(b.date);
    if(da !== db) return db.localeCompare(da);
    const ta = formatTimeExcel(asText(a.time)), tb = formatTimeExcel(asText(b.time));
    return tb.localeCompare(ta);
  }
  
  function renderAirlineDetail(s){
    const cat = STATE.expandedCat;
    const all = s.flights.slice().sort(flightSortDesc);
  
    const filtered = cat
      ? all.filter(f => f.__cov && f.__cov.cat === cat)
      : all;
  
    // Modelle (unique) aus den Flights dieser Auswahl
    const models = [];
    for(const f of filtered){
      const ms = (f.__cov && Array.isArray(f.__cov.models)) ? f.__cov.models : [];
      for(const m of ms){
        const mid = asText(m.model_id);
        if(mid) models.push(m);
      }
    }
  
    const uniqModelIds = uniq(models.map(m=>asText(m.model_id)));
    const modelRows = uniqModelIds.map(mid=>{
      const m = models.find(x=>asText(x.model_id)===mid) || {};
      const st = asText(m.status);
      const isExact = true; // in Detail-„Modelle“-Liste sind wir ohnehin in einer konkreten Kategorie
      const dotM = (st==="owned") ? dot("owned", isExact) : (st==="ordered") ? dot("ordered", isExact) : "";
      return `
        <tr>
          <td class="mono"><a href="./model.html?id=${esc(mid)}">${esc(mid)}</a></td>
          <td class="mono">${esc(asText(m.registration))}</td>
          <td class="dDots">${dotM}</td>
        </tr>
      `;
    }).join("");
  
    const flightsRows = filtered.map(f=>{
      const date = formatDateDE(asText(f.date));
      const time = formatTimeExcel(asText(f.time));
      const route = [asText(f.from), asText(f.to)].filter(Boolean).join(" → ");
      const reg = asText(f.registration);
      const typ = asText(f.typ_anzeige) || asText(f.aircraft_id);
      const covDot = dotHtml(f.__cov?.cat || "");
  
      const href = `./flight.html?id=${encodeURIComponent(asText(f.flight_id))}`;
      return `
        <tr>
          <td class="mono"><a href="${esc(href)}">${esc(date)}${time ? " " + esc(time) : ""}</a></td>
          <td class="mono">${esc(route)}</td>
          <td class="mono">${esc(asText(f.flight_no))}</td>
          <td class="mono">${esc(reg)}</td>
          <td>${esc(typ)}</td>
          <td class="dDots">${covDot}</td>
        </tr>
      `;
    }).join("");
  
    const title =
      (cat==="exact_owned") ? "Exakt vorhanden (Typ+Airline+Reg)" :
      (cat==="type_owned") ? "Typ+Airline vorhanden" :
      (cat==="exact_ordered") ? "Exakt bestellt (Typ+Airline+Reg)" :
      (cat==="type_ordered") ? "Typ+Airline bestellt" :
      "Alle Flüge dieser Airline";
  
    return `
      <div class="detailBox">
        <div class="detailTitle">${esc(title)} · ${filtered.length} Flüge</div>
  
        <table class="detailTbl">
          <thead>
            <tr>
              <th>Datum</th>
              <th>Route</th>
              <th>Flug</th>
              <th>Reg.</th>
              <th>Typ</th>
              <th class="dDots">Status</th>
            </tr>
          </thead>
          <tbody>${flightsRows || `<tr><td colspan="6" class="muted">Keine Treffer.</td></tr>`}</tbody>
        </table>
  
        ${
          cat
            ? `
              <div class="detailTitle" style="margin-top:12px">Modelle (konkret)</div>
              <table class="detailTbl">
                <thead>
                  <tr>
                    <th>Modell-ID</th>
                    <th>Reg.</th>
                    <th class="dDots">Status</th>
                  </tr>
                </thead>
                <tbody>${modelRows || `<tr><td colspan="3" class="muted">Keine Modelle.</td></tr>`}</tbody>
              </table>
            `
            : ``
        }
      </div>
    `;
  }
  
  function renderAirlinesTable(){
    const stats = CACHE.airlineStats;
  
    let out = `
    <div class="card">
      <div class="k">Airlines</div>
      <table class="tbl">
        <thead>
          <tr>
            <th>Airline</th>
            <th class="col-num">Flüge</th>
            <th class="col-num">${dot("owned",true)} exakt</th>
            <th class="col-num">${dot("owned",false)} Typ+Air</th>
            <th class="col-num">${dot("ordered",true)} exakt</th>
            <th class="col-num">${dot("ordered",false)} Typ+Air</th>
          </tr>
        </thead>
        <tbody>
    `;
  
    for(const s of stats){
      const lid = s.logo_id;
      const isOpen = (STATE.expandedAir === lid);
  
      const cell = (cat, n) => {
        const val = n || 0;
        if(!val) return `<span class="muted">–</span>`;
        return `<a class="numLink" href="#" data-air="${esc(lid)}" data-cat="${esc(cat)}">${val}</a>`;
      };
  
      out += `
        <tr class="rowMain ${isOpen ? "open" : ""}">
          <td>
            <a class="airLink" href="#" data-air="${esc(lid)}" data-cat="">${esc(airlineLabel(lid))}</a>
            <div class="muted mono">${esc(lid)}</div>
          </td>
          <td class="col-num mono">${s.total}</td>
          <td class="col-num mono">${cell("exact_owned", s.exact_owned)}</td>
          <td class="col-num mono">${cell("type_owned", s.type_owned)}</td>
          <td class="col-num mono">${cell("exact_ordered", s.exact_ordered)}</td>
          <td class="col-num mono">${cell("type_ordered", s.type_ordered)}</td>
        </tr>
      `;
  
      if(isOpen){
        out += `
          <tr class="rowDetail">
            <td colspan="6">
              ${renderAirlineDetail(s)}
            </td>
          </tr>
        `;
      }
    }
  
    out += `</tbody></table></div>`;
    return out;
  }
  
  // build + render
  CACHE.logoName = buildLogoName(models);
  CACHE.flights = flights;
  CACHE.models = models;
  CACHE.airlineStats = buildAirlineStats();
  
  html += renderAirlinesTable();
  
  // Click handling: nur 1 Airline offen
  document.addEventListener("click", (ev)=>{
    const a = ev.target.closest("a[data-air]");
    if(!a) return;
    ev.preventDefault();
  
    const air = a.getAttribute("data-air") || "";
    const cat = a.getAttribute("data-cat") || "";
  
    // Toggle (gleiche Airline + cat leer) -> zuklappen
    if(STATE.expandedAir === air && !cat){
      STATE.expandedAir = "";
      STATE.expandedCat = "";
    }else{
      STATE.expandedAir = air;
      STATE.expandedCat = cat; // "" oder eine Kategorie
    }
  
    // neu rendern: Overview + Airlines
    renderStats(CACHE.flights, CACHE.models);
  });

  document.getElementById("content").innerHTML = html;
}

main();
</script>
</body>
</html>
