<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Modell – Details</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:16px;line-height:1.35;max-width:900px}
    .top{display:flex;gap:10px;align-items:baseline;flex-wrap:wrap}
    h1{font-size:20px;margin:0}
    .pill{border:1px solid #ddd;border-radius:999px;padding:2px 8px;font-size:12px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    a{color:#000}
    .card{border:1px solid #ddd;border-radius:12px;padding:12px;margin:10px 0}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:640px){ .grid{grid-template-columns:1fr} }
    .k{color:#666;font-size:12px;text-transform:uppercase;letter-spacing:.04em}
    .v{font-size:15px;margin-top:2px;word-break:break-word}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .err{border:1px solid #c00;background:#fff5f5;padding:12px;border-radius:12px}
    .muted{color:#666;font-size:12px}
    .btn{display:inline-block;border:1px solid #ddd;border-radius:10px;padding:8px 10px;text-decoration:none}
    .btn:hover{background:#fafafa}
    table{width:100%;border-collapse:collapse}
    td{padding:6px 6px;border-bottom:1px solid #eee;vertical-align:top}
    td:first-child{color:#666;width:32%;font-size:12px;text-transform:uppercase;letter-spacing:.04em}
    .badge{display:inline-block;border:1px solid #ddd;border-radius:999px;padding:2px 8px;font-size:12px}
    .badge-warn{border-color:#c00;background:#fff5f5}
    .sectionGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:640px){ .sectionGrid{grid-template-columns:1fr} }

  </style>
</head>
<body>

<div class="top">
  <h1 id="title">Modell</h1>
  <span class="pill mono" id="idpill"></span>
  <span class="pill badge-warn" id="statuspill" style="display:none"></span>
</div>

<div class="muted" id="subtitle"></div>

<div id="content" class="card">Lade Daten …</div>

<div class="row">
  <a class="btn" href="./index.html">← Übersicht</a>
</div>

<script>
  function logoSrc(d){
    if(!d || !d.logo) return "";
  
    const link = String(d.logo.link || "").trim();
    if(/^https?:\/\//i.test(link)) return link;
  
    // optional: lokale Logos (falls du sie später ablegst)
    const id = String(d.logo.id || "").trim();
    if(id) return `./assets/logos/${encodeURIComponent(id)}.png`;
  
    return "";
  }
  
  function qs(name){
    const u = new URL(window.location.href);
    return u.searchParams.get(name);
  }

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function firstNonEmpty(...vals){
    for(const v of vals){
      if(v !== undefined && v !== null && String(v).trim() !== "") return String(v).trim();
    }
    return "";
  }
  
  function scaleBadge(scale){
    const s = String(scale ?? "").trim();
    if(!s) return "";
    const isSpecial = (s !== "1:400");
    const cls = isSpecial ? "badge badge-warn mono" : "badge mono";
    return `<span class="${cls}">${esc(s)}</span>`;
  }

  function rowHtml(k, vHtml){
    if(vHtml === undefined || vHtml === null || vHtml === "") return "";
    return `<div><div class="k">${esc(k)}</div><div class="v">${vHtml}</div></div>`;
  }
  
  function row(k,v){
    if(v === undefined || v === null || v === "") return "";
    return `<div><div class="k">${esc(k)}</div><div class="v">${esc(v)}</div></div>`;
  }

  function linkRow(k, url){
    if(!url) return "";
    const safe = esc(url);
    return `<div><div class="k">${esc(k)}</div><div class="v"><a href="${safe}" target="_blank" rel="noopener">${safe}</a></div></div>`;
  }

  function formatDateDE(iso){
    if(!iso) return "";
    const m = String(iso).match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return iso;
    return `${m[3]}.${m[2]}.${m[1]}`;
  }
  
  // Globale Währungs-Konfiguration
  const CURRENCY = { symbol: "€", position: "before", space: true };
  
  function money(v){
    // Fallback, falls CURRENCY aus irgendeinem Grund nicht global verfügbar ist
    const CUR = (typeof CURRENCY !== "undefined" && CURRENCY)
      ? CURRENCY
      : { symbol: "€", position: "before", space: true };
  
    if(v === null || v === undefined || v === "") return "";
    const n = Number(v);
    if(!Number.isFinite(n)) return String(v);
  
    const amount = n.toFixed(2).replace(".", ",");
    const sp = CUR.space ? " " : "";
  
    return CUR.position === "before"
      ? `${CUR.symbol}${sp}${amount}`
      : `${amount}${sp}${CUR.symbol}`;
  }

  function boolBadge(v){
    if(v === true) return "ja";
    if(v === false) return "nein";
    return "";
  }

  function asText(v){
    return (v ?? "").toString().trim();
  }

  function renderV8Table(obj){
    if(!obj || typeof obj !== "object") return "";

    function normListHtml(v){
      const s = String(v ?? "").trim();
      if(!s) return "";
      return s
        .split(/[|,]/g)
        .map(x => x.trim())
        .filter(Boolean)
        .join("<br>");
    }

    function translateWingtip(v){
      const x = String(v ?? "").trim().toUpperCase();
      const map = {
        "NONE": "Keine",
        "SL": "Sharklets",
        "WL": "Winglets",
        "RW": "Raked Wingtips"
      };
      return map[x] ? `${map[x]} (${x})` : String(v ?? "").trim();
    }

    function translateRumpf(v){
      const x = String(v ?? "").trim();
      const map = {
        "SingleAisle": "Schmalrumpf (Single Aisle)",
        "TwinAisle": "Großraum (Twin Aisle)"
      };
      return map[x] || x;
    }

    function translateRole(v){
      const x = String(v ?? "").trim().toUpperCase();
      const map = {
        "PAX": "Passagierflugzeug (PAX)",
        "CARGO": "Frachtflugzeug (Cargo)"
      };
      return map[x] || String(v ?? "").trim();
    }

    const spec = [
      ["Typ_anzeige", "Flugzeugtyp"],
      ["Hersteller", "Hersteller"],
      ["Baureihe", "Baureihe"],
      ["Unterserie", "Unterserie"],
      ["Marketingname", "Marketingname"],
      ["Alternate_designations", "Alternative Bezeichnungen", normListHtml],
      ["parent_aircraft_id", "Übergeordneter Typ (ID)"],

      ["ICAO", "ICAO-Typcode"],
      ["IATA", "IATA-Typcode"],

      ["Wingtip", "Wingtip / Winglets / Sharklets", (v)=>esc(translateWingtip(v))],
      ["Rumpf", "Rumpf (Kategorie)", (v)=>esc(translateRumpf(v))],
      ["MarketSegment", "Segment"],
      ["Role", "Rolle", (v)=>esc(translateRole(v))],

      ["Flugzeugtyp", "Flugzeugtyp (Kategorie)"],

      ["Erstflug", "Erstflug"],
      ["Status", "Status"],
      ["Antrieb", "Antrieb"],
      ["Triebwerke", "Triebwerke"],
      ["Reichweite", "Reichweite (Kategorie)"],
      ["Passengers", "Passagiere (Sitze)"],

      ["Length", "Länge (m)"],
      ["Wingspan", "Spannweite (m)"],
      ["Height", "Höhe (m)"],

      ["Wiki", "Wikipedia"],
      // aircraft_id bewusst NICHT hier, weil oben im Modellblock vorhanden
    ];

    const rows = spec
      .map(([key, label, fmt]) => {
        const v = obj[key];
        if(v === undefined || v === null) return null;
        const raw = String(v).trim();
        if(!raw) return null;

        if(key === "Wiki"){
          const url = raw;
          const safe = esc(url);
          return [label, `<a href="${safe}" target="_blank" rel="noopener">${safe}</a>`];
        }

        if(typeof fmt === "function"){
          // fmt liefert bereits escaped/HTML
          const html = fmt(raw);
          if(!html) return null;
          return [label, html];
        }

        return [label, esc(raw)];
      })
      .filter(Boolean);

    if(rows.length === 0) return "";

    let html = `<div class="card"><div class="k">Flugzeugdaten</div>` +
               `<div class="v" style="margin-top:8px"><table>`;

    for(const [label, valueHtml] of rows){
      html += `<tr><td>${esc(label)}</td><td>${valueHtml}</td></tr>`;
    }

    html += `</table></div></div>`;
    return html;
  }

  function extractFirstHttpUrl(text){
    const s = String(text ?? "").trim();
    if(!s) return { prefix: "", url: "" };
  
    const m = s.match(/https?:\/\/\S+/i);
    if(!m) return { prefix: s, url: "" };
  
    const url = m[0];
    const prefix = s.replace(url, "").trim().replace(/[;,:]$/, "").trim();
    return { prefix, url };
  }
  
  function linkOrTextRow(label, raw){
    const s = String(raw ?? "").trim();
    if(!s) return "";
    const { prefix, url } = extractFirstHttpUrl(s);
  
    if(!url){
      // kein http -> reiner Text
      return row(label, s);
    }
  
    // url vorhanden -> prefix als Text (wenn vorhanden) + url als Link
    const safeUrl = esc(url);
    const prefixHtml = prefix ? `${esc(prefix)}<br>` : "";
    return rowHtml(label, `${prefixHtml}<a href="${safeUrl}" target="_blank" rel="noopener">${safeUrl}</a>`);
  }
  
  async function main(){
    const id = qs("id");
    const pill = document.getElementById("idpill");
    if(pill) pill.style.display = "none";
    document.getElementById("idpill").textContent = id ? `id=${id}` : "id=?";

    if(!id){
      document.getElementById("content").innerHTML =
        `<div class="err"><b>Fehler:</b> Keine <span class="mono">id</span> in der URL. Beispiel: <span class="mono">model.html?id=OS016</span></div>`;
      return;
    }

    const url = `./data/${encodeURIComponent(id)}.json`;

    try{
      const res = await fetch(url, {cache:"no-store"});
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const d = await res.json();

      const airline = asText(d.airline_row) || asText(d.airline) || asText(d.airline_code);
      const typ = asText(d.aircraft_type) || asText(d.aircraft?.type);
      const reg = asText(d.registration) || asText(d.aircraft?.registration);
      const livery = asText(d.livery_name) || asText(d.livery?.code);

      const showAirlineText = (asText(d.logo_speaking).toUpperCase() !== "WAHR");

      // Headline: Typ + Reg + (optional) Taufname, Airline nur wenn Logo NICHT sprechend ist
      const logoSpeaking = asText(d.logo_speaking).toUpperCase() === "WAHR";
      const showAirlineText = !logoSpeaking;
      
      const titleMain = [
        typ,
        reg,
        d.aircraft_name ? `„${d.aircraft_name}“` : ""
      ].filter(Boolean).join(" · ") || id;
      
      document.title = showAirlineText
        ? `${airline} · ${titleMain}`
        : titleMain;
      
      const logoUrl = logoSrc(d);
      const logoHtml = logoUrl
        ? `<img src="${esc(logoUrl)}" alt="Logo" style="height:34px;vertical-align:middle;margin-right:10px">`
        : "";
      
      // Header: Logo links + Title (Typ/Reg) rechts
      document.getElementById("title").innerHTML = `${logoHtml}${esc(titleMain)}`;
      
      // Airline als eigene Zeile nur wenn nicht redundant
      const airlineLine = showAirlineText && airline ? airline : "";

      
      const orderedAt = asText(d.ordered_at || "");
      const orderedText = (d.ordered && orderedAt) ? `Bestellt: ${formatDateDE(orderedAt)}` : "";
      
      const sub = [
        airlineLine,
        livery ? `Livery: ${livery}` : "",
        d.livery_note ? `Bemalung: ${d.livery_note}` : "",
        orderedText
      ].filter(Boolean).join(" | ");
      
      document.getElementById("subtitle").textContent = sub;

      // Status (Bestellt)
      const statusPill = document.getElementById("statuspill");
      const orderedAt = asText(d.ordered_at || d.orderedAt || "");
      const isOrdered = !!d.ordered && !!orderedAt;
      
      if(isOrdered){
        statusPill.style.display = "";
        statusPill.textContent = `Bestellt: ${formatDateDE(orderedAt)}`;
      }else{
        statusPill.style.display = "none";
        statusPill.textContent = "";
      }

      // Blocks
      const modelBlock = `
        <div class="card">
          <div class="k">Modell</div>
          <div class="grid" style="margin-top:8px">
            ${rowHtml("Maßstab", scaleBadge(d.model?.scale || ""))}
            ${row("Hersteller", d.manufacturer || d.model?.manufacturer || "")}
            ${row("Artikel-/Modellnummer", d.model?.model_number || "")}
            ${linkOrTextRow("Shop", d.shop_url || d.shop || d.model?.shop || "")}
            ${row("Preis", money(d.price ?? d.model?.price))}
            ${row("Versand (anteilig)", money(d.shipping_allocated ?? d.model?.shipping_allocated))}
            ${row("Bestellt am", formatDateDE(d.ordered_at || d.orderedAt || ""))}
            ${row("Angekommen", formatDateDE(d.arrived || d.model?.arrived || ""))}
            ${row("Mitgeflogen", boolBadge(d.flown ?? d.model?.flown))}
            ${row("Besonderheit", d.special_note || d.model?.special_note || "")}
          </div>
        </div>
      `;

      const aircraftBlock = `
        <div class="card">
          <div class="k">Flugzeug</div>
          <div class="grid" style="margin-top:8px">
            ${row("Flugzeugtyp", typ)}
            ${row("Registrierung", reg)}
            ${row("Taufname", d.aircraft_name || "")}
            ${row("Zusatzinfo", d.extra_info || "")}
          </div>
        </div>
      `;


      const liveryName = (d.livery_full?.Livery_Name || "").trim();
      const liveryType = (d.livery_full?.Livery_Type || "").trim();
      const liveryNotes = (d.livery_full?.Notes || "").trim();
      
      const liveryBlock = `
        <div class="card">
          <div class="k">Bemalung</div>
          <div class="grid" style="margin-top:8px">
            ${row("Bezeichnung", liveryName)}
            ${row("Typ", liveryType)}
            ${row("Erläuterung", liveryNotes)}
          </div>
        </div>
      `;

      const linksBlock = `
        <div class="card">
          <div class="k">Links</div>
          <div class="grid" style="margin-top:8px">
            ${linkOrTextRow("Shop", d.shop_url || "")}
            ${linkOrTextRow("Postkarte", d.postcard || d.links?.postcard || "")}
            ${row("Preis Postkarte", money(d.postcard_price || ""))}
            ${linkOrTextRow("Foto", d.photo || d.links?.photo || "")}
          </div>
        </div>
      `;

      
      // Optional: show raw source pointer
      const src = d.source ? `(${d.source.sheet || ""} #${d.source.row || ""})` : "";
      const sourceBlock = src ? `<div class="muted">Quelle: ${esc(src)}</div>` : "";

      const v8Block = renderV8Table(d.aircraft_full_v8);

      document.getElementById("content").innerHTML =
        `<div class="sectionGrid">${modelBlock}${aircraftBlock}</div>` +
        liveryBlock + linksBlock + v8Block + sourceBlock;


    }catch(e){
      document.getElementById("content").innerHTML =
        `<div class="err"><b>Fehler:</b> Konnte <span class="mono">${esc(url)}</span> nicht laden. (${esc(e.message)})</div>`;
    }
  }

  main();
</script>
</body>
</html>
