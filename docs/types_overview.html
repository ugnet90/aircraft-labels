<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Typen-√úbersicht</title>
  <link rel="stylesheet" href="./style.css">
  <link rel="stylesheet" href="./types_overview.css">
</head>
<body>
  <div class="top">
    <h1>Typen-√úbersicht</h1>
    <span class="muted" id="meta"></span>
  </div>

  <div class="row">
    <a class="btn" href="./index.html">‚Üê √úbersicht</a>
    <a class="btn" href="./matrix.html">Matrix</a>
    <a class="btn" href="./missing_types.html">Fehlende Typen</a>
  </div>

  <div class="card controls">
    <div class="bar">
      <input id="q" placeholder="Suche (Typ / aircraft_id / Hersteller)" />

      <select id="manu"></select>

      <div class="statusFilters">
        <label><input type="checkbox" id="fMissing" checked> fehlend</label>
        <label><input type="checkbox" id="fOwned" checked> vorhanden</label>
        <label><input type="checkbox" id="fOrdered" checked> bestellt</label>
      </div>

      <select id="wing"></select>

      <select id="sort"></select>
    </div>

    <div class="muted" id="count"></div>
  </div>

  <div id="content"></div>

<script>
  function esc(s){
    return String(s??"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function norm(s){ return String(s ?? "").trim().toLowerCase(); }

  let data = null;
  let all = [];
  let expanded = new Set(); // aircraft_id

  function buildSelect(id, firstLabel, options){
    const sel = document.getElementById(id);
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = firstLabel;
    sel.appendChild(opt0);

    for(const x of options){
      const opt = document.createElement("option");
      opt.value = x;
      opt.textContent = x;
      sel.appendChild(opt);
    }
  }

  function buildStaticSelects(){
    const statusSel = document.getElementById("status");
    statusSel.innerHTML = `
      <option value="">Status: alle</option>
      <option value="missing">fehlend</option>
      <option value="owned">vorhanden</option>
      <option value="ordered">bestellt</option>
      <option value="mixed">vorhanden + bestellt</option>
    `;


    // has_wingtip filter: all/true/false
    const wing = document.getElementById("wing");
    wing.innerHTML = `
      <option value="">Wingtip: alle</option>
      <option value="true">Wingtip: ja</option>
      <option value="false">Wingtip: nein</option>
    `;

    const sort = document.getElementById("sort");
    sort.innerHTML = `
      <option value="type_az">Sort: Typ A‚ÜíZ</option>
      <option value="owned_desc">Sort: vorhanden ‚Üì</option>
      <option value="ordered_desc">Sort: bestellt ‚Üì</option>
      <option value="manufacturer_az">Sort: Hersteller A‚ÜíZ</option>
    `;
  }

  function apply(){
    const q = norm(document.getElementById("q").value);
    const manu = document.getElementById("manu").value;
    const status = document.getElementById("status").value;
    const wing = document.getElementById("wing").value;
    const sort = document.getElementById("sort").value || "type_az";
    const fMissing = document.getElementById("fMissing").checked;
    const fOwned = document.getElementById("fOwned").checked;
    const fOrdered = document.getElementById("fOrdered").checked;
    
    items = items.filter(x => {
      const hasOwned = x.owned_count > 0;
      const hasOrdered = x.ordered_count > 0;
    
      if(!fMissing && !hasOwned && !hasOrdered) return false;
      if(!fOwned && hasOwned) return false;
      if(!fOrdered && hasOrdered) return false;
    
      return true;
    });


    let items = all.filter(x => {
      if(manu && (x.manufacturer || "") !== manu) return false;
      if(status && (x.status || "") !== status) return false;

      if(wing === "true" && x.has_wingtip !== true) return false;
      if(wing === "false" && x.has_wingtip !== false) return false;

      if(!q) return true;
      const hay = (norm(x.typ_anzeige) + " " + norm(x.aircraft_id) + " " + norm(x.manufacturer));
      return hay.includes(q);
    });

    items = sortItems(items, sort);

    document.getElementById("count").textContent =
      `${items.length} Typen ¬∑ davon ${items.filter(x=>x.total_count>0).length} mit Modellen`;

    render(items);
  }

  function sortItems(items, mode){
    const arr = items.slice();
    if(mode === "owned_desc"){
      arr.sort((a,b)=>(b.owned_count-a.owned_count) || (a.type_key||"").localeCompare(b.type_key||""));
      return arr;
    }
    if(mode === "ordered_desc"){
      arr.sort((a,b)=>(b.ordered_count-a.ordered_count) || (a.type_key||"").localeCompare(b.type_key||""));
      return arr;
    }
    if(mode === "manufacturer_az"){
      arr.sort((a,b)=> (a.manufacturer||"").localeCompare(b.manufacturer||"") || (a.type_key||"").localeCompare(b.type_key||""));
      return arr;
    }
    arr.sort((a,b)=> (a.type_key||"").localeCompare(b.type_key||""));
    return arr;
  }

  function statusLabel(st){
    switch(st){
      case "missing": return "fehlend";
      case "owned": return "vorhanden";
      case "ordered": return "bestellt";
      case "mixed": return "vorhanden + bestellt";
      default: return "";
    }
  }

  function statusBadge(st){
    const s = st || "";
    const lbl = statusLabel(s);
    const cls = "badge " + (s ? "st-" + s : "");
    return lbl ? `<span class="${cls}">${esc(lbl)}</span>` : "";
  }

  function wingBadge(v){
    return v === true ? `<span class="badge">WL/SL</span>` : "";
  }

  function render(items){
    if(items.length === 0){
      document.getElementById("content").innerHTML = `<div class="err">Keine Treffer.</div>`;
      return;
    }

    let html = `
      <table class="tbl">
        <thead>
          <tr>
            <th class="col-status">Status</th>
            <th class="col-type">Typ</th>
            <th class="col-manu">Hersteller</th>
            <th class="col-wing">WL</th>
            <th class="col-num">best.</th>
            <th class="col-num">vorh.</th>
          </tr>
        </thead>
        <tbody>
    `;

    for(const x of items){
      const isOpen = expanded.has(x.aircraft_id);
      const canOpen = (x.status !== "missing");
    
      const toggleHtml = canOpen
        ? `<button class="toggle" data-aid="${esc(x.aircraft_id)}" aria-label="Details">
             ${isOpen ? "‚ñæ" : "‚ñ∏"}
           </button>`
        : ""; // kein Platzhalter mehr!
    
      html += `
        <tr class="rowMain st-${esc(x.status || "")}" data-aid="${esc(x.aircraft_id)}">
          <td class="col-status">
            ${toggleHtml}
          </td>
    
          <td class="col-type">
            <div class="typeLine">
              <div>
                <div class="typeName">
                  ${esc(x.typ_anzeige || x.aircraft_id)}
                  <a class="typeLink"
                     href="./index.html?aircraft_id=${encodeURIComponent(x.aircraft_id || "")}"
                     title="Alle Airlines dieses Typs anzeigen">‚ÜóÔ∏é</a>
                </div>
                <div class="muted mono">${esc(x.aircraft_id)}</div>
              </div>
            </div>
          </td>
    
          <td class="col-manu">${esc(x.manufacturer || "")}</td>
          <td class="col-wing">${wingBadge(x.has_wingtip === true)}</td>
    
          <td class="col-num mono">${(x.ordered_count > 0) ? esc(x.ordered_count) : ""}</td>
          <td class="col-num mono">${(x.owned_count > 0) ? esc(x.owned_count) : ""}</td>
        </tr>
      `;
    
      if(isOpen && canOpen){
        html += `
          <tr class="rowDetail">
            <td colspan="6">
              ${renderDetail(x)}
            </td>
          </tr>
        `;
      }
    }

    html += `</tbody></table>`;
    document.getElementById("content").innerHTML = html;
  }

  function renderDetail(x){
    const groups = Array.isArray(x.airline_group_counts) ? x.airline_group_counts : [];
    if(groups.length === 0){
      return `<div class="muted">Keine Modelle vorhanden/bestellt.</div>`;
    }
  
    let html = `
      <table class="detailTbl">
        <thead>
          <tr>
            <th>Airline-Gruppe</th>
            <th>Airline</th>
            <th class="col-status">Status</th>
          </tr>
        </thead>
        <tbody>
    `;
  
    for(const g of groups){
      const groupName = g.group || "";
      const airlines = Array.isArray(g.airlines) ? g.airlines : [];
  
      for(const a of airlines){
        const aName = a.airline || "";
        const owned = a.owned || 0;
        const ordered = a.ordered || 0;
  
        html += `
          <tr>
            <td>
              <a href="./index.html?group=${encodeURIComponent(groupName)}&aircraft_id=${encodeURIComponent(x.aircraft_id || "")}">
                ${esc(groupName)}
              </a>
            </td>
            <td>
              <a href="./index.html?group=${encodeURIComponent(groupName)}&airline=${encodeURIComponent(aName)}&aircraft_id=${encodeURIComponent(x.aircraft_id || "")}">
                ${esc(aName)}
              </a>
            </td>
            <td class="dStatus">
              ${owned > 0 ? `
                <a class="dot"
                   href="./index.html?group=${encodeURIComponent(groupName)}&airline=${encodeURIComponent(aName)}&aircraft_id=${encodeURIComponent(x.aircraft_id || "")}&status=owned"
                   title="Vorhandene Modelle anzeigen">üü¢</a>` : ""}
  
              ${ordered > 0 ? `
                <a class="dot"
                   href="./index.html?group=${encodeURIComponent(groupName)}&airline=${encodeURIComponent(aName)}&aircraft_id=${encodeURIComponent(x.aircraft_id || "")}&status=ordered"
                   title="Bestellte Modelle anzeigen">üü°</a>` : ""}
            </td>
          </tr>
        `;
      }
    }
  
    html += `</tbody></table>`;
    return html;
  }

  let wantScrollAid = "";
  
  document.addEventListener("click", (ev)=>{
    const btn = ev.target.closest("button.toggle");
    if(!btn) return;
  
    const aid = btn.getAttribute("data-aid") || "";
    if(!aid) return;
  
    const x = all.find(it => it.aircraft_id === aid);
    if(!x || x.status === "missing") return;
  
    if(expanded.has(aid)){
      expanded.clear();
      wantScrollAid = ""; // nichts scrollen
    }else{
      expanded.clear();     // nur 1 offen
      expanded.add(aid);
      wantScrollAid = aid;  // nach dem Render dahin scrollen
    }
  
    apply();
  
    // Nach dem Render: Zeile ins Sichtfeld scrollen (sanft)
    if(wantScrollAid){
      requestAnimationFrame(() => {
        const tr = document.querySelector(`tr.rowMain[data-aid="${CSS.escape(wantScrollAid)}"]`);
        if(tr) tr.scrollIntoView({ behavior: "smooth", block: "nearest" });
      });
    }
  });

  async function main(){
    const res = await fetch("./data/types_overview.json", {cache:"no-store"});
    data = await res.json();
    all = data.items || [];

    document.getElementById("meta").textContent =
      `${data.master_count || all.length} Typen ¬∑ fehlend: ${data.missing ?? ""}`;

    buildStaticSelects();
    buildSelect("manu", "Hersteller: alle", (data.filters?.manufacturers || []));

    // events
    document.getElementById("q").addEventListener("input", apply);
    document.getElementById("manu").addEventListener("change", apply);
    document.getElementById("status").addEventListener("change", apply);
    document.getElementById("wing").addEventListener("change", apply);
    document.getElementById("sort").addEventListener("change", apply);
    document.getElementById("fMissing").addEventListener("change", apply);
    document.getElementById("fOwned").addEventListener("change", apply);
    document.getElementById("fOrdered").addEventListener("change", apply);

    apply();
  }

  main();
</script>
</body>
</html>
