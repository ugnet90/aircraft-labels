<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Flugzeugmodelle – Übersicht</title>
  <link rel="stylesheet" href="./style.css">
  <link rel="stylesheet" href="./index.css">
</head>
<body>

<h1>Flugzeugmodelle – Übersicht</h1>
<div class="meta" id="meta">Lade Daten …</div>

<div class="bar">
  <input id="q" placeholder="Suche (ID, Reg, Typ, Bemalung …)" />
  <select id="group">
    <option value="">Alle Airline-Gruppen</option>
  </select>
  <select id="airline">
    <option value="">Alle Airlines</option>
  </select>
  <select id="type">
    <option value="">Alle Flugzeugtypen</option>
  </select>
  <select id="scale">
    <option value="">Alle Maßstäbe</option>
  </select>
  <select id="sort">
    <option value="group_model">Sortierung: Airline-Gruppe → Modell-ID</option>
    <option value="airline_model">Sortierung: Airline → Modell-ID</option>
    <option value="arrived_desc">Sortierung: angekommen (neu → alt)</option>
    <option value="arrived_asc">Sortierung: angekommen (alt → neu)</option>
    <option value="type">Sortierung: Flugzeugtyp</option>
    <option value="reg">Sortierung: Registrierung</option>
  </select>  
  <select id="flown">
    <option value="">Mitgeflogen: egal</option>
    <option value="true">Mitgeflogen: ja</option>
    <option value="false">Mitgeflogen: nein</option>
  </select>

</div>

<div class="right">
  <a class="pill" href="./types_overview.html">Typen-Übersicht</a>
  <a class="pill" href="./missing_types.html">Fehlende Typen</a>
  <a class="pill" href="./matrix.html">Matrix</a>
  <button id="reset" class="pill" style="cursor:pointer;background:#fff">Reset</button>
  <span class="small" id="count"></span>
</div>


<div id="content"></div>

<script>
  const state = { all: [], filtered: [] };

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function norm(s){ return String(s ?? "").toLowerCase().trim(); }

  function formatDateDE(iso){
    if(!iso) return "";
    const m = String(iso).match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return iso; // fallback
    return `${m[3]}.${m[2]}.${m[1]}`;
  }

  function formatDateTimeDE(isoUtc){
    if(!isoUtc) return "";
    const m = String(isoUtc).match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})/);
    if(!m) return isoUtc;
    return `${m[3]}.${m[2]}.${m[1]} ${m[4]}:${m[5]}`;
  }
  
  function parseDateISO(s){
    if(!s) return null;
    const m = String(s).match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return null;
    const d = new Date(`${m[1]}-${m[2]}-${m[3]}T00:00:00Z`);
    return isNaN(d.getTime()) ? null : d;
  }
  
  function scaleBadge(scale){
    const s = String(scale ?? "").trim();
    if(!s) return "";
    const isSpecial = (s !== "1:400");
    const cls = isSpecial ? "badge badge-warn mono" : "badge mono";
    return `<span class="${cls}">${esc(s)}</span>`;
  }
  
  function buildOptions(items, selectId, keyFn, labelFn){
    const sel = document.getElementById(selectId);
    const map = new Map();
    for(const it of items){
      const key = keyFn(it);
      if(!key) continue;
      if(!map.has(key)) map.set(key, labelFn(it));
    }
  
    const pairs = Array.from(map.entries()); // [key, label]
    pairs.sort((a,b)=> String(a[1]).localeCompare(String(b[1]))); // nach Label
  
    for(const [k, label] of pairs){
      const opt = document.createElement("option");
      opt.value = k;
      opt.textContent = label;
      sel.appendChild(opt);
    }
  }

  function matchesQuery(it, q){
    if(!q) return true;
    const hay = [
      it.model_id, it.airline_code, it.airline_row, it.airline,
      it.aircraft_id, it.aircraft_type,
      it.registration, it.livery_name,
      it.livery_display,
      it.arrived,
      it.ordered ? "bestellt" : "",
      it.ordered_at,
      it.scale,
      (it.flown===true?"mitgeflogen":it.flown===false?"nicht mitgeflogen":"")
    ].map(norm).join(" | ");

    return hay.includes(q);
  }

  function matchesAirline(it, code){
    if(!code) return true;
    return (it.airline_row || "") === code;
  }

  function matchesType(it, t){
    if(!t) return true;
    return (it.aircraft_type || "") === t;
  }

  function matchesScale(it, s){
    if(!s) return true;
    return (it.scale || "") === s;
  }

  function matchesFlown(it, v){
    if(!v) return true;
    if(v === "true") return it.flown === true;
    if(v === "false") return it.flown === false;
    return true;
  }

  function sortItems(items, mode){
    const arr = items.slice();

    if(mode === "arrived_desc" || mode === "arrived_asc"){
      arr.sort((a,b)=>{
        const da = parseDateISO(a.arrived)?.getTime() ?? -1;
        const db = parseDateISO(b.arrived)?.getTime() ?? -1;
        return mode === "arrived_desc" ? (db - da) : (da - db);
      });
      return arr;
    }
    if(mode === "type"){
      arr.sort((a,b)=> (a.aircraft_type||"").localeCompare(b.aircraft_type||"") || (a.model_id||"").localeCompare(b.model_id||""));
      return arr;
    }
    if(mode === "reg"){
      arr.sort((a,b)=> (a.registration||"").localeCompare(b.registration||"") || (a.model_id||"").localeCompare(b.model_id||""));
      return arr;
    }

    if(mode === "group_model"){
      arr.sort((a,b)=>
        (a.airline||"").localeCompare(b.airline||"") ||
        (a.model_id||"").localeCompare(b.model_id||"")
      );
      return arr;
    }

    arr.sort((a,b)=>
      (a.airline_row||"").localeCompare(b.airline_row||"") ||
      (a.model_id||"").localeCompare(b.model_id||"")
    );
    return arr;
  }

  function render(items){
    document.getElementById("count").textContent = (items.length === 1) ? "1 Modell" : `${items.length} Modelle`;

    if(items.length === 0){
      document.getElementById("content").innerHTML = `<div class="err">Keine Treffer.</div>`;
      return;
    }

    let html = `
      <table>
        <thead>
          <tr>
            <th>Modell-ID</th>
            <th>Airline-Gruppe</th>
            <th>Airline</th>
            <th class="hide-m">Maßstab</th>
            <th class="hide-m">Mitgeflogen</th>
            <th>Flugzeugtyp</th>
            <th>WL/SL</th>
            <th class="hide-m">Registrierung</th>
            <th class="hide-m">Bemalung</th>
            <th class="hide-m">Angekommen</th>
          </tr>
        </thead>
        <tbody>
    `;

    for(const it of items){
      const link = `./model.html?id=${encodeURIComponent(it.model_id)}`;
      html += `
        <tr>
          <td class="mono">
            <a href="./model.html?id=${encodeURIComponent(it.model_id)}" title="Modell anzeigen">
              ${
                (it.model_id || "").startsWith("ORD-")
                  ? `<span class="badge-id ord" title="${esc(it.model_id)}">ORD</span>`
                  : `${esc(it.model_id || "")}`
              }
            </a>
          </td>
          <td>
            <a href="#" data-group="${esc(it.airline || "")}">
              ${esc(it.airline || "")}
            </a>
          </td>
          <td>
            <a href="#" data-airline="${esc(it.airline_row || "")}">
              ${esc(it.airline_row || it.airline || it.airline_code || "")}
            </a>
          </td>
          <td class="hide-m">${scaleBadge(it.scale || "")}</td>
          <td class="mono hide-m">${it.flown === true ? "ja" : it.flown === false ? "nein" : ""}</td>
          <td>
            <a href="#" data-aircraft-id="${esc(it.aircraft_id || "")}" data-type="${esc(it.aircraft_type || "")}">
              ${esc(it.aircraft_type || "")}
            </a>
          </td>
          <td class="mono">
            ${
              (it.has_wingtip === true) || ((it.wingtip || "").toUpperCase() && (it.wingtip || "").toUpperCase() !== "NONE")
                ? `<span class="badge">ja</span>`
                : ""
            }
          </td>
          <td class="mono hide-m">${esc(it.registration || "")}</td>
          <td class="hide-m">${esc(it.livery_display || it.livery_name || "")}</td>
          <td class="mono hide-m">
            ${esc(formatDateDE(it.arrived || ""))}
            ${
              it.ordered === true && !it.arrived
                ? ` <span class="badge badge-ordered">bestellt${it.ordered_at ? " " + esc(formatDateDE(it.ordered_at)) : ""}</span>`
                : ""
            }
          </td>
        </tr>
      `;
    }

    html += `</tbody></table>`;
    document.getElementById("content").innerHTML = html;
  }

  

  function apply(){
    const q = norm(document.getElementById("q").value);
    const group = document.getElementById("group").value;
    const airline = document.getElementById("airline").value;
    const type = document.getElementById("type").value;
    const scale = document.getElementById("scale").value;
    const flown = document.getElementById("flown").value;
    const sort = document.getElementById("sort").value;
  
    let items = state.all.filter(it => {
      if (!matchesQuery(it, q)) return false;
      if (!matchesAirline(it, airline)) return false;
      const grp = (it.airline || it.group || it.airline_group || "");
      if (group && grp !== group) return false;   // ⭐ Airline-Gruppe

      // if (group && (it.airline || "") !== group) return false;
      if (!matchesType(it, type)) return false;
      if (!matchesScale(it, scale)) return false;
      if (!matchesFlown(it, flown)) return false;
      return true;
    });
  
    items = sortItems(items, sort);
    state.filtered = items;
    render(items);
  }


  async function main(){
    try{
      const res = await fetch("./index.json", {cache:"no-store"});
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      state.all = data.items || [];

      document.getElementById("meta").innerHTML =
        `<span class="pill">Stand: <span class="mono">${esc(formatDateTimeDE(data.generated_at || ""))}</span></span>` +
        `<span class="pill">Anzahl: <span class="mono">${esc(data.count || state.all.length)}</span></span>`;
      
      buildOptions(state.all, "group",
        it => (it.airline || ""),   // airline = Gruppe (Sheet)
        it => (it.airline || "")
      );

      buildOptions(state.all, "airline",
        it => (it.airline_row || ""),
        it => (it.airline_row || "")
      );
      buildOptions(state.all, "type",
        it => (it.aircraft_type || ""),
        it => (it.aircraft_type || "")
      );

      buildOptions(state.all, "scale",
        it => (it.scale || ""),
        it => (it.scale || "")
      );

      document.getElementById("q").addEventListener("input", apply);
      document.getElementById("group").addEventListener("change", apply);
      document.getElementById("airline").addEventListener("change", apply);
      document.getElementById("type").addEventListener("change", apply);
      document.getElementById("scale").addEventListener("change", apply);
      document.getElementById("flown").addEventListener("change", apply);
      document.getElementById("sort").addEventListener("change", apply);
      document.getElementById("reset").addEventListener("click", () => {
        document.getElementById("q").value = "";
        document.getElementById("group").value = "";
        document.getElementById("airline").value = "";
        document.getElementById("type").value = "";
        document.getElementById("scale").value = "";
        document.getElementById("flown").value = "";
        document.getElementById("sort").value = "group_model";
        apply();

        // URL bereinigen (Query-Parameter entfernen)
        history.replaceState(null, "", location.pathname);
      });

      // =========================
      // URL-Parameter -> Filter setzen (Matrix / Mobile Links)
      // =========================
      const p = new URLSearchParams(location.search);

      if (p.has("q")) {
        document.getElementById("q").value = p.get("q") || "";
      }
      if (p.has("aircraft_id")) {
        // aircraft_id hat Priorität: wir setzen den Typ-Filter NICHT,
        // sondern nutzen die Suche (matchesQuery enthält aircraft_id bereits)
        document.getElementById("q").value = p.get("aircraft_id") || "";
      }

      if (p.has("group")) {
        document.getElementById("group").value = p.get("group") || "";
      }
      if (p.has("airline")) {
        document.getElementById("airline").value = p.get("airline") || "";
      }
      if (p.has("type")) {
        document.getElementById("type").value = p.get("type") || "";
      }
      if (p.has("scale")) {
        document.getElementById("scale").value = p.get("scale") || "";
      }
      if (p.has("flown")) {
        document.getElementById("flown").value = p.get("flown") || "";
      }
      if (p.has("sort")) {
        document.getElementById("sort").value = p.get("sort") || document.getElementById("sort").value;
      }

      apply();

    }catch(e){
      document.getElementById("content").innerHTML =
        `<div class="err"><b>Fehler:</b> Konnte <span class="mono">docs/index.json</span> nicht laden. (${esc(e.message)})</div>`;
      document.getElementById("meta").textContent = "";
    }
  }

  document.addEventListener("click", (ev) => {
    const a = ev.target.closest("a[data-airline], a[data-type], a[data-group], a[data-aircraft-id]");
    if(!a) return;
  
    ev.preventDefault();

    const aid = a.getAttribute("data-aircraft-id");
    const airline = a.getAttribute("data-airline");
    const type = a.getAttribute("data-type");
    const group = a.getAttribute("data-group");
  
    // "Fresh" start: alle Filter zurücksetzen
    document.getElementById("q").value = "";
    document.getElementById("group").value = "";
    document.getElementById("airline").value = "";
    document.getElementById("type").value = "";
    document.getElementById("scale").value = "";
    document.getElementById("flown").value = "";
    // sort NICHT zwingend resetten – wenn du willst, nächste Zeile aktivieren:
    // document.getElementById("sort").value = "group_model";
  
    // Nur den geklickten Filter setzen
    if(group !== null){
      document.getElementById("group").value = group;
    }
    if(airline !== null){
      document.getElementById("airline").value = airline;
    }
    if(aid){
      document.getElementById("q").value = aid;   // aircraft_id als Suchfilter
      document.getElementById("type").value = ""; // Typ-Text bewusst leeren
    }

    if(!aid && type !== null){
      document.getElementById("type").value = type;
    }
  
    apply();
  });
  
  main();

</script>
</body>
</html>
