<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Flüge</title>
  <link rel="stylesheet" href="./style.css">
  <link rel="stylesheet" href="./flights.css">
</head>
<body>

  <!-- NAV: in alle Seiten gleich -->
  <nav class="nav">
    <div class="navInner">
      <div class="navRight">
        <a href="./index.html">Übersicht</a>
        <a href="./matrix.html">Matrix</a>
        <a href="./missing_types.html">Fehlende Typen</a>
        <a href="./types_overview.html">Typen</a>
        <a class="active" href="./flights.html">Flüge</a>
        <a href="./stats.html">Stats</a>
      </div>
    </div>
  </nav>

  <div class="top" style="margin-top:10px">
    <h1>Flüge</h1>
    <span class="muted" id="meta"></span>
  </div>

  <div id="content" class="card">Lade Daten …</div>

<script>
  let sortKey = "date";
  let sortDir = "desc"; // "asc" | "desc"
  
  function getVal(x, key){
    const v = x[key];
    return (v === null || v === undefined) ? "" : String(v);
  }
  
  function cmp(a, b){
    const va = getVal(a, sortKey);
    const vb = getVal(b, sortKey);
  
    // Spezial: date (YYYY-MM-DD) und time
    if(sortKey === "date"){
      return (va.localeCompare(vb)) * (sortDir === "asc" ? 1 : -1);
    }
    if(sortKey === "time"){
      // Vergleich über formatTimeExcel -> Minuten
      const ta = formatTimeExcel(va);
      const tb = formatTimeExcel(vb);
      return (ta.localeCompare(tb)) * (sortDir === "asc" ? 1 : -1);
    }
  
    // Standard String compare
    return (va.localeCompare(vb, "de", {numeric:true, sensitivity:"base"})) * (sortDir === "asc" ? 1 : -1);
  }
  
  function setSort(key){
    if(sortKey === key){
      sortDir = (sortDir === "asc") ? "desc" : "asc";
    }else{
      sortKey = key;
      sortDir = "asc";
    }
    applyRender(); // musst du auf deine Render-Funktion mappen
  }

  function esc(s){
    return String(s??"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function formatTimeExcel(v){
    if(v === null || v === undefined) return "";
    const s = String(v).trim();
    if(!s) return "";
  
    // "HH:MM" / "HH:MM:SS" bereits ok
    if(/^\d{1,2}:\d{2}(:\d{2})?$/.test(s)) return s;
  
    // Excel: 0,552083... oder 0.552083...
    const num = Number(s.replace(",", "."));
    if(!Number.isFinite(num)) return s;
  
    // Tagesanteil -> Sekunden
    const totalSeconds = Math.round(num * 24 * 60 * 60);
    const hh = Math.floor(totalSeconds / 3600) % 24;
    const mm = Math.floor((totalSeconds % 3600) / 60);
    // const ss = totalSeconds % 60; // falls du Sekunden willst
  
    return String(hh).padStart(2,"0") + ":" + String(mm).padStart(2,"0");
  }

  function formatDateDE(iso){
    if(!iso) return "";
    const m = String(iso).match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return iso;
    return `${m[3]}.${m[2]}.${m[1]}`;
  }
  function asText(v){ return (v??"").toString().trim(); }

  let allFlights = [];
  
  function renderFlights(items){
    const mark = (key) => {
      if(sortKey !== key) return `<span class="sortMark">↕</span>`;
      return `<span class="sortMark active">${sortDir === "asc" ? "↑" : "↓"}</span>`;
    };
  
    const thClass = (key, base) => (sortKey === key ? `${base} thSort active` : `${base} thSort`);
  
    let html = `
      <table class="tbl">
        <thead>
          <tr>
            <th class="${thClass("date","col-date")}" data-sort="date">Datum ${mark("date")}</th>
            <th class="${thClass("route","col-route")}" data-sort="route">Route ${mark("route")}</th>
            <th class="${thClass("airline","col-air")}" data-sort="airline">Airline ${mark("airline")}</th>
            <th class="${thClass("flight_no","col-fn")}" data-sort="flight_no">Flug ${mark("flight_no")}</th>
            <th class="${thClass("aircraft_id","col-type")}" data-sort="aircraft_id">Flugzeugtyp ${mark("aircraft_id")}</th>
            <th class="${thClass("registration","col-reg")}" data-sort="registration">Reg. ${mark("registration")}</th>
          </tr>
        </thead>
        <tbody>
    `;
  
    for(const f of items){
      const dateRaw = asText(f.date);
      const date = formatDateDE(dateRaw);
  
      const time = formatTimeExcel(asText(f.time));
      const from = asText(f.from);
      const to = asText(f.to);
      const route = [from, to].filter(Boolean).join(" → ");
  
      const airline = asText(f.airline) || asText(f.logo_id);
      const fn = asText(f.flight_no);
  
      const typ = asText(f.typ_anzeige) || asText(f.aircraft_id);
      const aid = asText(f.aircraft_id);
  
      const reg = asText(f.registration);
      const regLink = f.reg_url
        ? `<a href="${esc(f.reg_url)}" target="_blank" rel="noopener">${esc(reg)}</a>`
        : esc(reg);
  
      html += `
        <tr>
          <td class="col-date mono" data-label="Datum">
            <div class="dDate">${esc(date)}</div>
            ${time ? `<div class="dTime">${esc(time)}</div>` : ``}
          </td>
          <td class="col-route mono" data-label="Route">${esc(route)}</td>
          <td class="col-air" data-label="Airline">${esc(airline)}</td>
          <td class="col-fn mono" data-label="Flug">${esc(fn)}</td>
          <td class="col-type" data-label="Flugzeugtyp">
            <div>${esc(typ)}</div>
            <div class="muted mono">${esc(aid)}</div>
          </td>
          <td class="col-reg mono" data-label="Reg.">${regLink}</td>
        </tr>
      `;
    }
  
    html += `</tbody></table>`;
    document.getElementById("content").innerHTML = html;
  }

  
  function applyRender(){
    const items = allFlights.slice();
  
    // Route + Airline-Feld virtuell fürs Sortieren (cmp benutzt getVal(x, key))
    for(const f of items){
      const from = asText(f.from);
      const to = asText(f.to);
      f.route = [from, to].filter(Boolean).join(" → ");
      f.airline = asText(f.airline) || asText(f.logo_id);
    }
  
    items.sort(cmp);
    renderFlights(items);
  
    document.getElementById("meta").textContent =
      `${items.length} Flüge · Sort: ${sortKey} ${sortDir === "asc" ? "↑" : "↓"}`;
  }
  
  async function main(){
    const res = await fetch("./data/flights.json", {cache:"no-store"});
    const data = await res.json();
    allFlights = data.items || [];
  
    applyRender();
  
    // Klick auf Header -> sortieren
    document.addEventListener("click", (ev)=>{
      const th = ev.target.closest("th[data-sort]");
      if(!th) return;
      setSort(th.getAttribute("data-sort"));
    });
  }
  
  main();

</script>
</body>
</html>
