<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Flug – Details</title>
  <link rel="stylesheet" href="./style.css">
  <link rel="stylesheet" href="./flight.css">
</head>
<body>

  <!-- NAV: in alle Seiten gleich -->
  <nav class="nav">
    <div class="navInner">
      <div class="navRight">
        <a href="./index.html">Übersicht</a>
        <a href="./matrix.html">Matrix</a>
        <a href="./missing_types.html">Fehlende Typen</a>
        <a href="./types_overview.html">Typen</a>
        <a href="./flights.html">Flüge</a>
        <a href="./stats.html">Stats</a>
      </div>
    </div>
  </nav>

  <div class="top" style="margin-top:10px">
    <h1 id="title">Flug</h1>
    <span class="muted" id="meta"></span>
  </div>

  <div class="row" style="margin-top:10px">
    <a class="btn" href="./flights.html">← Flüge</a>
    <a class="btn" href="./index.html">Übersicht</a>
  </div>

  <div id="content" class="card" style="margin-top:12px">Lade Daten …</div>

<script>
  function timeToMinutes(v){
    if(v === null || v === undefined) return 0;
    const s = String(v).trim();
    if(!s) return 0;
  
    // "HH:MM" / "HH:MM:SS"
    const m = s.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
    if(m){
      const hh = Number(m[1] || 0);
      const mm = Number(m[2] || 0);
      return (hh * 60) + mm;
    }
  
    // Excel fraction 0,552083... / 0.552083...
    const num = Number(s.replace(",", "."));
    if(Number.isFinite(num)){
      const totalMinutes = Math.round(num * 24 * 60);
      return totalMinutes;
    }
  
    return 0;
  }
  
  function flightStamp(f){
    const d = String(f.date || "").trim();
    // Wenn Datum fehlt: ans Ende
    if(!/^\d{4}-\d{2}-\d{2}$/.test(d)) return Number.MAX_SAFE_INTEGER;
  
    const mins = timeToMinutes(f.time);
    // YYYY-MM-DD -> Minutenstempel
    const [Y,M,D] = d.split("-").map(Number);
    const ts = Date.UTC(Y, (M-1), D, 0, 0, 0);
    return ts + (mins * 60 * 1000);
  }
  
  function normKey(v){
    return String(v ?? "").trim().toUpperCase();
  }
  
  // Ermittelt FIRST-Maps über ALLE Flüge (chronologisch ASC)
  function computeFirstMaps(allFlights){
    const flights = (allFlights || []).slice().sort((a,b)=> flightStamp(a) - flightStamp(b));
  
    const first = {
      airline: new Map(),        // logo_id
      type: new Map(),           // aircraft_id
      reg: new Map(),            // registration
      airlineType: new Map(),    // logo_id|aircraft_id
      airlineReg: new Map(),     // logo_id|registration
    };
  
    for(const f of flights){
      const id = String(f.flight_id || "").trim();
      if(!id) continue;
  
      const a = normKey(f.logo_id);
      const t = normKey(f.aircraft_id);
      const r = normKey(f.registration);
  
      if(a && !first.airline.has(a)) first.airline.set(a, id);
      if(t && !first.type.has(t)) first.type.set(t, id);
      if(r && !first.reg.has(r)) first.reg.set(r, id);
  
      if(a && t){
        const k = a + "|" + t;
        if(!first.airlineType.has(k)) first.airlineType.set(k, id);
      }
      if(a && r){
        const k = a + "|" + r;
        if(!first.airlineReg.has(k)) first.airlineReg.set(k, id);
      }
    }
  
    return first;
  }
  
  // Baut Badges für den aktuellen Flug
  function buildFirstBadges(f, firstMaps){
    const id = String(f.flight_id || "").trim();
    if(!id) return "";
  
    const a = normKey(f.logo_id);
    const t = normKey(f.aircraft_id);
    const r = normKey(f.registration);
  
    const badges = [];
  
    if(a && firstMaps.airline.get(a) === id) badges.push("Erstflug Airline");
    if(t && firstMaps.type.get(t) === id) badges.push("Erstflug Typ");
    if(r && firstMaps.reg.get(r) === id) badges.push("Erstflug Reg");
  
    if(a && t && firstMaps.airlineType.get(a + "|" + t) === id) badges.push("Erstflug Airline+Typ");
    if(a && r && firstMaps.airlineReg.get(a + "|" + r) === id) badges.push("Erstflug Airline+Reg");
  
    if(!badges.length) return "";
  
    // Du hast .badge/.pill bereits – wir nutzen .badge-warn als auffällig, sonst .badge
    return badges.map(x => `<span class="badge badge-warn">${x}</span>`).join(" ");
  }

  function qs(name){
    const u = new URL(window.location.href);
    return u.searchParams.get(name);
  }

  function esc(s){
    return String(s??"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function asText(v){ return (v??"").toString().trim(); }

  function formatDateDE(iso){
    if(!iso) return "";
    const m = String(iso).match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return iso;
    return `${m[3]}.${m[2]}.${m[1]}`;
  }

  function formatTimeExcel(v){
    if(v === null || v === undefined) return "";
    const s = String(v).trim();
    if(!s) return "";

    // "HH:MM" / "HH:MM:SS" bereits ok
    if(/^\d{1,2}:\d{2}(:\d{2})?$/.test(s)) return s.slice(0,5);

    // Excel: 0,552083... oder 0.552083...
    const num = Number(s.replace(",", "."));
    if(!Number.isFinite(num)) return s;

    const totalSeconds = Math.round(num * 24 * 60 * 60);
    const hh = Math.floor(totalSeconds / 3600) % 24;
    const mm = Math.floor((totalSeconds % 3600) / 60);
    return String(hh).padStart(2,"0") + ":" + String(mm).padStart(2,"0");
  }

  function kvRow(k, vHtml){
    if(!vHtml) return "";
    return `<tr><td>${esc(k)}</td><td>${vHtml}</td></tr>`;
  }

  function kvText(k, v){
    const s = asText(v);
    if(!s) return "";
    return kvRow(k, esc(s));
  }

  function linkA(url, text){
    const u = asText(url);
    if(!u) return "";
    const t = asText(text) || u;
    return `<a href="${esc(u)}" target="_blank" rel="noopener">${esc(t)}</a>`;
  }

  function badgeDot(kind, title){
    // kind: "owned" | "ordered"
    const cls = (kind === "owned") ? "dot dotG" : "dot dotY";
    return `<span class="${cls}" title="${esc(title)}"></span>`;
  }

  function normalize(s){
    return asText(s).toLowerCase();
  }

  function sameAirline(model, flight){
    // models: airline_row (echte Airline), airline (Gruppe), airline_code
    // flights: airline (aus logos), logo_id
    const fAir = normalize(flight.airline) || normalize(flight.logo_id);
    const mAir = normalize(model.airline_row) || normalize(model.airline_code) || normalize(model.airline);
    return fAir && mAir && (mAir === fAir);
  }

  function analyzeFlight(models, flight, logoMap){
    const fAircraftId = asText(flight.aircraft_id);
    const fReg = asText(flight.registration);
  
    const sameAirlineFn = (m) => {
      // flight: logo_id -> Airline-Text aus airline_logos.csv
      const fLogo = asText(flight.logo_id);
      const fAir  = normalize((logoMap && logoMap.get(fLogo)) ? logoMap.get(fLogo) : fLogo);
  
      // model: echte Airline (airline_row) ist die Referenz
      const mAir = normalize(m.airline_row) || normalize(m.airline_code) || normalize(m.airline);
  
      return fAir && mAir && (fAir === mAir);
    };
  
    const sameType = (m) =>
      fAircraftId && asText(m.aircraft_id) === fAircraftId;
  
    const sameReg = (m) =>
      fReg && asText(m.registration) === fReg;
  
    const airlineTypeModels = models.filter(m =>
      sameType(m) && sameAirlineFn(m)
    );
  
    const exactModels = airlineTypeModels.filter(m =>
      sameReg(m)
    );
  
    return { airlineTypeModels, exactModels };
  }


  function dotOnly(kind, filled, title){
    const base = (kind === "owned") ? "dot dotG" : "dot dotY";
    const cls = filled ? base : (base + " dotO");
    const t = title ? ` title="${esc(title)}"` : "";
    return `<span class="${cls}"${t} aria-hidden="true"></span>`;
  }

  async function main(){
    const id = qs("id");
    if(!id){
      document.getElementById("content").innerHTML =
        `<div class="err"><b>Fehler:</b> Keine <span class="mono">id</span> in der URL. Beispiel: <span class="mono">flight.html?id=F0001</span></div>`;
      return;
    }

    try{
      // flights
      const resF = await fetch("./data/flights.json", {cache:"no-store"});
      if(!resF.ok) throw new Error(`flights.json HTTP ${resF.status}`);
      const flights = await resF.json();
      const items = flights.items || [];
      
      const firstMaps = computeFirstMaps(items);

      const f = items.find(x => asText(x.flight_id) === asText(id));
      if(!f){
        document.getElementById("content").innerHTML =
          `<div class="err"><b>Fehler:</b> Flug <span class="mono">${esc(id)}</span> nicht gefunden.</div>`;
        return;
      }
      const firstBadgesHtml = buildFirstBadges(f, firstMaps);
      
      const resL = await fetch("./data/airline_logos.csv", {cache:"no-store"});
      if(!resL.ok) throw new Error(`airline_logos.csv HTTP ${resL.status}`);
      const logosCsv = await resL.text();
      
      function parseCsvSemi(text){
        const lines = text.split(/\r?\n/).filter(Boolean);
        if(lines.length < 2) return [];
        const header = lines[0].split(";").map(s=>s.trim());
        const rows = [];
        for(let i=1;i<lines.length;i++){
          const cols = lines[i].split(";");
          const obj = {};
          for(let j=0;j<header.length;j++){
            obj[header[j]] = (cols[j] ?? "").trim();
          }
          rows.push(obj);
        }
        return rows;
      }
      
      const logoRows = parseCsvSemi(logosCsv);
      const logoMap = new Map(
        logoRows.map(r => [String(r.logo_id||"").trim(), String(r.Airline||"").trim()])
      );
      
      // models index (für Matching)
      const resI = await fetch("./index.json", {cache:"no-store"});
      const idx = await resI.json();
      const models = idx.items || [];

      const dateISO = asText(f.date);
      const timeRaw = asText(f.time);
      const dateDE = formatDateDE(dateISO);
      const timeHHMM = formatTimeExcel(timeRaw);

      const from = asText(f.from);
      const to = asText(f.to);
      const route = [from,to].filter(Boolean).join(" → ");

      const airlineId = asText(f.logo_id);
      const airline = logoMap.get(airlineId) || airlineId;
      const flightNo = asText(f.flight_no);
      const callsign = asText(f.callsign);

      const reg = asText(f.registration);
      const regUrl = asText(f.reg_url) || (reg ? `https://airport-data.com/aircraft/${encodeURIComponent(reg)}.html` : "");
      const regLink = reg ? linkA(regUrl, reg) : "";

      const typ = asText(f.typ_anzeige) || asText(f.type) || asText(f.aircraft_id);
      const aircraftId = asText(f.aircraft_id);
      const manu = asText(f.manufacturer);
      const wingtip = asText(f.wingtip);

      document.title = `${dateDE}${timeHHMM ? " " + timeHHMM : ""} · ${route || "Flug"} · ${reg || typ || "Details"}`;
      document.getElementById("title").textContent = `${route || "Flug"}${dateDE ? " · " + dateDE : ""}${timeHHMM ? " " + timeHHMM : ""}`;
      document.getElementById("meta").innerHTML =
        esc([airline, flightNo].filter(Boolean).join(" · ")) +
        (firstBadgesHtml
          ? `<div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">${firstBadgesHtml}</div>`
          : "");

      // Matching
      const analysis = analyzeFlight(models, f, logoMap);
      const exact = analysis.exactModels;
      const typeMatches = analysis.airlineTypeModels;
      
      let summaryDot = "";
      let summaryText = "";
      
      if(exact.length){
        const owned = exact.some(m => m.status === "owned");
        const ordered = exact.some(m => m.status === "ordered");
      
        summaryDot =
          (owned   ? dotOnly("owned",   true,  "Vorhanden") : "") +
          (ordered ? dotOnly("ordered", true,  "Bestellt")  : "");
      
        summaryText = "Dieses konkrete Flugzeug ist in deiner Sammlung.";
      }
      else if(typeMatches.length){
        const owned = typeMatches.some(m => m.status === "owned");
        const ordered = typeMatches.some(m => m.status === "ordered");
      
        summaryDot =
          (owned   ? dotOnly("owned",   false, "Typ vorhanden") : "") +
          (ordered ? dotOnly("ordered", false, "Typ bestellt")  : "");
      
        summaryText = "Typ vorhanden, aber andere Registrierung.";
      }
      else{
        summaryText = "Kein Modell dieses Typs in deiner Sammlung.";
      }

      
      let detailRows = "";
      
      const displayModels = exact.length ? exact : typeMatches;
      
      const isExactContext = exact.length > 0; // wenn wir gerade exakte Reg-Matches anzeigen => gefüllt
      for(const m of displayModels){
        const dot =
          (m.status === "owned")   ? dotOnly("owned",   isExactContext, "Vorhanden") :
          (m.status === "ordered") ? dotOnly("ordered", isExactContext, "Bestellt") :
          "";
      
        detailRows += `
          <tr>
            <td class="mono">
              <a href="./model.html?id=${esc(m.model_id)}">${esc(m.model_id)}</a>
            </td>
            <td class="mono">${esc(m.registration || "")}</td>
            <td>${dot}</td>
          </tr>
        `;
      }
      
      let matchHtml = `
        <div class="card">
          <div class="k">Sammlung</div>
      
          <div style="margin-top:10px; display:flex; align-items:center; gap:8px;">
            ${summaryDot}
            <div>${esc(summaryText)}</div>
          </div>
      `;
      
      if(displayModels.length){
        matchHtml += `
          <div style="margin-top:12px">
            <table class="tblSmall">
              <thead>
                <tr>
                  <th>Modell-ID</th>
                  <th>Reg.</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>${detailRows}</tbody>
            </table>
          </div>
        `;
      }
      
      matchHtml += `</div>`;

      // Detail-Blöcke
      const flightBlock = `
        <div class="card">
          <div class="k">Flug</div>
          <div style="margin-top:10px">
            <table class="kv">
              ${kvText("Datum", dateDE)}
              ${kvText("Zeit", timeHHMM)}
              ${kvText("Von", from)}
              ${kvText("Nach", to)}
              ${kvText("Route", route)}
              ${kvText("Airline", airline)}
              ${kvText("Linie", asText(f.line))}
              ${kvText("Flug-Nr.", flightNo)}
              ${kvText("Callsign", callsign)}
              ${kvText("Class", asText(f.travel_class))}
              ${kvText("Sitz", asText(f.seat))}
            </table>
          </div>
        </div>
      `;

      const aircraftBlock = `
        <div class="card">
          <div class="k">Flugzeug</div>
          <div style="margin-top:10px">
            <table class="kv">
              ${reg ? kvRow("Registrierung", regLink) : ""}
              ${kvText("Typ", typ)}
              ${kvText("aircraft_id", aircraftId)}
              ${kvText("Hersteller", manu)}
              ${kvText("Wingtip", wingtip)}
              ${kvText("MSN", asText(f.msn))}
              ${kvText("Mode-S / ICAO24", asText(f.mode_s))}
              ${kvText("Taufname", asText(f.search_name))}
              ${kvText("Anmerkungen", asText(f.notes))}
              ${kvText("Lounge", asText(f.lounge))}
              ${kvText("Buchungscode", asText(f.booking_code))}
              ${kvText("Ticket-Nr.", asText(f.ticket_no))}
            </table>
          </div>
        </div>
      `;

      document.getElementById("content").innerHTML =
        `<div class="sectionGrid">${flightBlock}${aircraftBlock}</div>` +
        matchHtml;

    }catch(e){
      document.getElementById("content").innerHTML =
        `<div class="err"><b>Fehler:</b> ${esc(e.message)}</div>`;
    }
  }

  main();
</script>
</body>
</html>
